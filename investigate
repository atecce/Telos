#!/usr/bin/env python
#
# I should not like my writing to spare other people the trouble of thinking. 
# But, if possible, to stimulate someone to thoughts of their own.
#

from canvas import database

class lyrics_site:

	# be patient
	import time

	# but don't wait for your neighbors
	import multiprocessing

	# and focus
	branching_factor = 8

	# set the canvas
	canvas = database.canvas()

	def communicate(self, url):

		from bs4 import BeautifulSoup
		import requests

		# never stop trying
		while True:

			# make some soup
			try:

				page = requests.get(url)
				soup = BeautifulSoup(page.content)

				return soup

			# give communication a chance
			except requests.exceptions.ConnectionError: pass

			self.time.sleep(1)

	def multitask(self, processes, process_name, process_target, process_args):

			process = self.multiprocessing.Process(name=process_name, target=process_target, args=process_args)

			processes.append(process)

			process.start()

			alive = [(process.name, process.is_alive()) for process in processes if process.is_alive()]
			
			while len(alive) >= self.branching_factor:

				alive = [(process.name, process.is_alive()) for process in processes if process.is_alive()]

				self.time.sleep(1)

class lyrics_net(lyrics_site): 

	url = 'http://www.lyrics.net/'

	def investigate(self):

		import re

		soup = self.communicate(self.url)

		alphabet_urls = (self.url + re.match('^/artists/[A-Z0]$', link.get('href')).group(0) + '/99999' \
				 for link in soup.find_all('div', {'id': 'page-letter-search'})[0]      	\
				          if re.match('^/artists/[A-Z0]$', str(link.get('href'))))

		artist_tags = (trace.strong.a 		  		     		  \
			       for alphabet_url in alphabet_urls 	     	 	  \
			       for trace in self.communicate(alphabet_url).find_all('tr') \
			       		 if trace.strong)

		artist_data = ((artist_tag.text, self.url + artist_tag.get('href')) for artist_tag in artist_tags)

		started = list()

		for artist_name, artist_url in artist_data: 

			artist_soup = self.communicate(artist_url)
			
			if artist_name in self.canvas.get_artists():

				print "\nArtist:", artist_name, "\nstarted already."

				started.append((artist_name, artist_soup))
				continue

			self.multitask(artists, artist_name, self.honor, (artist_name, artist_soup,))

		for artist_name, artist_soup in started: 

			self.multitask(artists, artist_name, self.honor, (artist_name, artist_soup,))

	def honor(self, artist_name, artist_soup):

		self.canvas.add_artist(artist_name)

		print "\nArtist:", artist_name, "\ninserted"

		album_labels = artist_soup.find_all('h3', {'class': 'artist-album-label'})

		started = list()

		for album_label in album_labels:

			album_title = album_label.a.text
			album_url   = self.url + album_label.a.get('href')

			album_soup = self.communicate(album_url)

			if album_title in self.canvas.get_albums(artist_name):

				started.append((album_title, album_soup))
				continue

			# TODO
			if album_soup.find_all('body', {'id': 's4-page-homepage'}): 
				
				print "\tArtist:", artist_name, "\n\tAlbum:", album_title, "\n\tredirects to home page\n"
				home_page_albums.append((artist_name, album_title))
				continue

			self.multitask(albums, album_title, self.admire, (artist_name, album_soup, album_title,))

		for album_title, album_soup in started: 

			self.multitask(albums, album_title, self.admire, (artist_name, album_soup, album_title,))

	def admire(self, artist_name, album_soup, album_title):

		self.canvas.add_album(artist_name, album_title)

		print "\n\tArtist:", artist_name, "\n\tAlbum:", album_title, "\n\tinserted"

		song_data = ((self.url + song_tag.a.get('href'), song_tag.a.text)  \
			     for song_tag in album_soup.find_all('strong') 	   \
			     		  if song_tag.a)

		for song_url, song_title in song_data:

			song_soup = self.communicate(song_url)

			# TODO
			if song_soup.find_all('body', {'id': 's4-page-homepage'}): 
				
				print "\n\t\tSong:", song_title, "\n\t\tAlbum:", album_title, "\n\t\tredirects to home page\n"
				home_page_songs.append((album_title, song_title))
				continue

			self.multitask(songs, song_title, self.experience, (album_title, song_soup, song_title,))

	def experience(self, album_title, song_soup, song_title):

		try: lyrics = song_soup.find_all('pre', {'id': 'lyric-body-text'})[0].text

		except IndexError: return

		self.canvas.add_song(album_title, song_title, lyrics)

		print "\t\tSong:", song_title, "\n\t\tAlbum:", album_title, "\n\t\tinserted\n"

		print

		for line in lyrics.splitlines(): print '\t\t\t', line

		print

if __name__ == '__main__':

	artists = list()
	albums  = list()
	songs   = list()

	home_page_albums = list()
	home_page_songs  = list()

	investigation = lyrics_net()

	investigation.investigate()
